{% extends "base.html" %}

{% block title %}Logs de Visitas - Admin{% endblock %}

{% block content %}
<div class="admin-layout">
    {% include 'admin_sidebar.html' %}
    
    <div class="admin-content">
        <div class="container-fluid py-4">
            <div class="row mb-4">
                <div class="col-12">
                    <h1 class="h3 fw-bold">
                        <i class="fas fa-list-alt me-2 text-primary"></i>Logs de Visitas
                    </h1>
                    <p class="text-muted">Auditoría completa de todas las visitas registradas</p>
                </div>
            </div>

            <!-- Filtros -->
            <div class="card mb-4">
                <div class="card-body">
                    <form method="GET" class="row g-3">
                        <div class="col-md-4">
                            <label class="form-label">Filtrar por Vehículo</label>
                            <select class="form-select" name="vehicle_id">
                                <option value="">Todos los vehículos</option>
                                {% for vehicle in vehicles %}
                                <option value="{{ vehicle.id }}" {% if current_vehicle_id == vehicle.id %}selected{% endif %}>
                                    {{ vehicle.title }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Vistas Bloqueadas</label>
                            <select class="form-select" name="blocked">
                                <option value="">Todas</option>
                                <option value="only" {% if current_blocked_filter == 'only' %}selected{% endif %}>Solo bloqueadas</option>
                                <option value="exclude" {% if current_blocked_filter == 'exclude' %}selected{% endif %}>Solo legítimas</option>
                            </select>
                        </div>
                        <div class="col-md-2 d-flex align-items-end">
                            <button type="submit" class="btn btn-primary w-100">
                                <i class="fas fa-filter me-2"></i>Filtrar
                            </button>
                        </div>
                        <div class="col-md-3 d-flex align-items-end">
                            <a href="{{ url_for('admin_view_logs') }}" class="btn btn-outline-secondary w-100">
                                <i class="fas fa-times me-2"></i>Limpiar
                            </a>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Tabla de Logs -->
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-database me-2"></i>Registros de Visitas
                    </h5>
                    <span class="badge bg-info">{{ pagination.total }} registros</span>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover table-sm mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th width="50">ID</th>
                                    <th>Timestamp</th>
                                    <th>Vehículo</th>
                                    <th>IP</th>
                                    <th>Dispositivo</th>
                                    <th>Navegador</th>
                                    <th>OS</th>
                                    <th>Referrer</th>
                                    <th>Estado</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for log in logs %}
                                <tr class="{% if not log.is_counted %}table-danger{% endif %}">
                                    <td>{{ log.id }}</td>
                                    <td>
                                        <small>{{ log.timestamp.strftime('%d/%m/%Y %H:%M:%S') if log.timestamp else '-' }}</small>
                                    </td>
                                    <td>
                                        {% if log.vehicle %}
                                        <a href="{{ url_for('vehicle_detail', id=log.vehicle.id) }}" target="_blank" class="text-decoration-none">
                                            {{ log.vehicle.title[:30] }}...
                                        </a>
                                        {% else %}
                                        <span class="text-muted">N/A</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <code class="text-primary">{{ log.ip_address or '-' }}</code>
                                    </td>
                                    <td>
                                        {% if log.device_type == 'mobile' %}
                                        <span class="badge bg-primary">
                                            <i class="fas fa-mobile"></i> {{ log.device_type }}
                                        </span>
                                        {% elif log.device_type == 'desktop' %}
                                        <span class="badge bg-success">
                                            <i class="fas fa-desktop"></i> {{ log.device_type }}
                                        </span>
                                        {% elif log.device_type == 'tablet' %}
                                        <span class="badge bg-info">
                                            <i class="fas fa-tablet"></i> {{ log.device_type }}
                                        </span>
                                        {% else %}
                                        <span class="text-muted">{{ log.device_type or '-' }}</span>
                                        {% endif %}
                                    </td>
                                    <td>{{ log.browser or '-' }}</td>
                                    <td>{{ log.os or '-' }}</td>
                                    <td>
                                        {% if log.referrer %}
                                        <small class="text-muted">{{ log.referrer[:30] }}...</small>
                                        {% else %}
                                        <span class="text-muted">Directo</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if log.is_counted %}
                                        <span class="badge bg-success">
                                            <i class="fas fa-check"></i> Contada
                                        </span>
                                        {% else %}
                                        <span class="badge bg-danger">
                                            <i class="fas fa-ban"></i> Bloqueada
                                        </span>
                                        {% if log.blocked_reason %}
                                        <br><small class="text-muted">{{ log.blocked_reason }}</small>
                                        {% endif %}
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Paginación -->
                {% if pagination.pages > 1 %}
                <div class="card-footer">
                    <nav>
                        <ul class="pagination pagination-sm mb-0 justify-content-center">
                            <li class="page-item {% if not pagination.has_prev %}disabled{% endif %}">
                                <a class="page-link" href="{% if pagination.has_prev %}{{ url_for('admin_view_logs', page=pagination.prev_num, vehicle_id=current_vehicle_id, blocked=current_blocked_filter) }}{% else %}#{% endif %}">
                                    Anterior
                                </a>
                            </li>
                            
                            {% for page_num in pagination.iter_pages(left_edge=1, right_edge=1, left_current=1, right_current=2) %}
                                {% if page_num %}
                                    <li class="page-item {% if page_num == pagination.page %}active{% endif %}">
                                        <a class="page-link" href="{{ url_for('admin_view_logs', page=page_num, vehicle_id=current_vehicle_id, blocked=current_blocked_filter) }}">
                                            {{ page_num }}
                                        </a>
                                    </li>
                                {% else %}
                                    <li class="page-item disabled"><span class="page-link">...</span></li>
                                {% endif %}
                            {% endfor %}
                            
                            <li class="page-item {% if not pagination.has_next %}disabled{% endif %}">
                                <a class="page-link" href="{% if pagination.has_next %}{{ url_for('admin_view_logs', page=pagination.next_num, vehicle_id=current_vehicle_id, blocked=current_blocked_filter) }}{% else %}#{% endif %}">
                                    Siguiente
                                </a>
                            </li>
                        </ul>
                    </nav>
                </div>
                {% endif %}
            </div>

            <!-- Info sobre los datos -->
            <div class="row mt-4">
                <div class="col-12">
                    <div class="card border-info">
                        <div class="card-body">
                            <h6 class="card-title">
                                <i class="fas fa-info-circle me-2 text-info"></i>Datos Recolectados por Visita
                            </h6>
                            <div class="row">
                                <div class="col-md-3">
                                    <small class="text-muted">Identificación:</small>
                                    <ul class="mb-0 small">
                                        <li>IP Address</li>
                                        <li>Session ID (hash único)</li>
                                        <li>Timestamp exacto</li>
                                    </ul>
                                </div>
                                <div class="col-md-3">
                                    <small class="text-muted">Dispositivo:</small>
                                    <ul class="mb-0 small">
                                        <li>Tipo (mobile/desktop/tablet)</li>
                                        <li>Navegador</li>
                                        <li>Sistema Operativo</li>
                                    </ul>
                                </div>
                                <div class="col-md-3">
                                    <small class="text-muted">Origen:</small>
                                    <ul class="mb-0 small">
                                        <li>Referrer (de dónde vino)</li>
                                        <li>Ciudad (en desarrollo)</li>
                                        <li>País (en desarrollo)</li>
                                    </ul>
                                </div>
                                <div class="col-md-3">
                                    <small class="text-muted">Anti-Fraude:</small>
                                    <ul class="mb-0 small">
                                        <li>¿Se contó? (is_counted)</li>
                                        <li>Razón de bloqueo</li>
                                        <li>¿Vista única del día?</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
