{% extends "base.html" %}

{% block title %}Gestión de Palabras Clave - Panel Administrativo{% endblock %}

{% block content %}
<div class="admin-layout">
    {% include 'admin_sidebar.html' %}
    
    <div class="admin-content">
        <div class="container-fluid py-4">
            <!-- Header -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h1 class="display-6 fw-bold">
                                <i class="fas fa-key me-3 text-primary"></i>Palabras Clave de Vendedores
                            </h1>
                            <p class="text-muted">Gestiona las palabras clave para agrupar vehículos por vendedor</p>
                        </div>
                        <div>
                            <a href="{{ url_for('admin_dashboard') }}" class="btn btn-outline-secondary me-2">
                                <i class="fas fa-arrow-left me-2"></i>Volver al Panel
                            </a>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Statistics Cards -->
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="card bg-primary text-white">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h4 class="card-title">{{ keyword_page_stats.total_keywords }}</h4>
                                    <p class="card-text">Palabras Clave Activas</p>
                                </div>
                                <div class="align-self-center">
                                    <i class="fas fa-key fa-2x"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-success text-white">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h4 class="card-title">{{ keyword_page_stats.total_vehicles_with_keywords }}</h4>
                                    <p class="card-text">Vehículos con Palabra Clave</p>
                                </div>
                                <div class="align-self-center">
                                    <i class="fas fa-car fa-2x"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-info text-white">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h4 class="card-title">{{ keyword_page_stats.avg_vehicles_per_keyword }}</h4>
                                    <p class="card-text">Promedio por Vendedor</p>
                                </div>
                                <div class="align-self-center">
                                    <i class="fas fa-chart-bar fa-2x"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-warning text-white">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h4 class="card-title">{{ keyword_page_stats.vehicles_without_keywords }}</h4>
                                    <p class="card-text">Sin Palabra Clave</p>
                                </div>
                                <div class="align-self-center">
                                    <i class="fas fa-exclamation-triangle fa-2x"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Keywords Table -->
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-list me-2"></i>Palabras Clave por Vendedor
                    </h5>
                </div>
                <div class="card-body">
                    {% if keyword_stats %}
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead class="table-dark">
                                    <tr>
                                        <th><i class="fas fa-key me-2"></i>Palabra Clave</th>
                                        <th><i class="fas fa-car me-2"></i>Vehículos</th>
                                        <th><i class="fas fa-eye me-2"></i>Visualizaciones</th>
                                        <th><i class="fas fa-mouse-pointer me-2"></i>Clics</th>
                                        <th><i class="fas fa-calendar me-2"></i>Último Vehículo</th>
                                        <th><i class="fas fa-cogs me-2"></i>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for keyword_data in keyword_stats %}
                                    <tr>
                                        <td>
                                            <strong class="text-primary">{{ keyword_data.keyword }}</strong>
                                            <br>
                                            <small class="text-muted">
                                                <a href="{{ url_for('seller_profile', keyword=keyword_data.keyword) }}" target="_blank" class="text-decoration-none me-2">
                                                    <i class="fas fa-user me-1"></i>Ver Perfil
                                                </a>
                                                <a href="/?search={{ keyword_data.keyword }}" target="_blank" class="text-decoration-none">
                                                    <i class="fas fa-search me-1"></i>Buscar
                                                </a>
                                            </small>
                                        </td>
                                        <td>
                                            <span class="badge bg-primary">{{ keyword_data.vehicle_count }}</span>
                                        </td>
                                        <td>
                                            <span class="badge bg-info">{{ keyword_data.total_views }}</span>
                                        </td>
                                        <td>
                                            <span class="badge bg-success">{{ keyword_data.total_clicks }}</span>
                                        </td>
                                        <td>
                                            <small class="text-muted">
                                                {{ keyword_data.latest_vehicle_date.strftime('%d/%m/%Y') if keyword_data.latest_vehicle_date else 'N/A' }}
                                            </small>
                                        </td>
                                        <td>
                                            <div class="btn-group" role="group">
                                                <button type="button" class="btn btn-sm btn-outline-primary" 
                                                        onclick="viewKeywordVehicles('{{ keyword_data.keyword }}')"
                                                        title="Ver vehículos">
                                                    <i class="fas fa-eye"></i>
                                                </button>
                                                <button type="button" class="btn btn-sm btn-outline-warning" 
                                                        onclick="editKeyword('{{ keyword_data.keyword }}')"
                                                        title="Editar palabra clave">
                                                    <i class="fas fa-edit"></i>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <div class="text-center py-4">
                            <i class="fas fa-key fa-3x text-muted mb-3"></i>
                            <h5 class="text-muted">No hay palabras clave configuradas</h5>
                            <p class="text-muted">Los vendedores pueden agregar palabras clave al editar sus vehículos</p>
                        </div>
                    {% endif %}
                </div>
            </div>

            <!-- How to Use Guide -->
            <div class="card mt-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-question-circle me-2"></i>¿Cómo funciona el sistema de palabras clave?
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6><i class="fas fa-user-plus me-2 text-primary"></i>Para Vendedores:</h6>
                            <ul class="list-unstyled">
                                <li><i class="fas fa-check text-success me-2"></i>Al editar un vehículo, pueden agregar una palabra clave única</li>
                                <li><i class="fas fa-check text-success me-2"></i>Ejemplo: "AUTOSDIEGO", "VENTASCARLOS", "CONCESIONARIAVUC"</li>
                                <li><i class="fas fa-check text-success me-2"></i>Todos sus vehículos pueden usar la misma palabra clave</li>
                                <li><i class="fas fa-check text-success me-2"></i>La palabra clave es modificable en cualquier momento</li>
                            </ul>
                        </div>
                        <div class="col-md-6">
                            <h6><i class="fas fa-search me-2 text-info"></i>Para Compradores:</h6>
                            <ul class="list-unstyled">
                                <li><i class="fas fa-check text-success me-2"></i>Pueden buscar la palabra clave en el buscador principal</li>
                                <li><i class="fas fa-check text-success me-2"></i>Aparecerán todos los vehículos de ese vendedor</li>
                                <li><i class="fas fa-check text-success me-2"></i>Facilita encontrar más opciones del mismo vendedor</li>
                                <li><i class="fas fa-check text-success me-2"></i>Mejora la experiencia de compra</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal for viewing vehicles by keyword -->
<div class="modal fade" id="keywordVehiclesModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-car me-2"></i>Vehículos con palabra clave: <span id="modalKeyword"></span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="keywordVehiclesContent">
                <!-- Content will be loaded here -->
            </div>
        </div>
    </div>
</div>

<script>
function viewKeywordVehicles(keyword) {
    document.getElementById('modalKeyword').textContent = keyword;
    
    // Load vehicles for this keyword
    fetch(`/admin/api/keyword-vehicles/${encodeURIComponent(keyword)}`)
        .then(response => response.json())
        .then(data => {
            let content = '';
            if (data.vehicles && data.vehicles.length > 0) {
                content = '<div class="row">';
                data.vehicles.forEach(vehicle => {
                    content += `
                        <div class="col-md-6 mb-3">
                            <div class="card">
                                <div class="card-body">
                                    <h6 class="card-title">${vehicle.title}</h6>
                                    <p class="card-text">
                                        <strong>${vehicle.price_formatted}</strong><br>
                                        <small class="text-muted">${vehicle.brand} ${vehicle.model} - ${vehicle.year || 'N/A'}</small>
                                    </p>
                                    <div class="d-flex justify-content-between">
                                        <a href="/admin/edit_vehicle/${vehicle.id}" class="btn btn-sm btn-outline-primary">
                                            <i class="fas fa-edit me-1"></i>Editar
                                        </a>
                                        <a href="/vehicle/${vehicle.id}" target="_blank" class="btn btn-sm btn-outline-info">
                                            <i class="fas fa-eye me-1"></i>Ver
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                });
                content += '</div>';
            } else {
                content = '<p class="text-muted text-center">No se encontraron vehículos para esta palabra clave.</p>';
            }
            
            document.getElementById('keywordVehiclesContent').innerHTML = content;
            new bootstrap.Modal(document.getElementById('keywordVehiclesModal')).show();
        })
        .catch(error => {
            console.error('Error:', error);
            document.getElementById('keywordVehiclesContent').innerHTML = 
                '<p class="text-danger text-center">Error al cargar los vehículos.</p>';
            new bootstrap.Modal(document.getElementById('keywordVehiclesModal')).show();
        });
}

function editKeyword(currentKeyword) {
    const newKeyword = prompt(`Cambiar palabra clave "${currentKeyword}" por:`, currentKeyword);
    
    if (newKeyword && newKeyword !== currentKeyword && newKeyword.trim() !== '') {
        if (confirm(`¿Estás seguro de cambiar "${currentKeyword}" por "${newKeyword.trim()}"?`)) {
            fetch('/admin/api/update-keyword', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    old_keyword: currentKeyword,
                    new_keyword: newKeyword.trim()
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    location.reload();
                } else {
                    alert('Error: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error al actualizar la palabra clave');
            });
        }
    }
}
</script>
{% endblock %}
